<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cf.comm.mapper.CommMapper">

    <select id="selectMenuList" parameterType="sqlMap" resultType="sqlMap">
        /* selectMenuList */
        WITH RECURSIVE menu_hierarchy AS (
            SELECT 'ROOT' AS MENU_ID
                 , null AS UP_MENU_ID
                 , '' AS PAGE_ID
                 , '' AS MENU_NM
                 , 0 AS SRT_SN
                 , 0 AS LEVEL
            UNION ALL
            SELECT sm.menu_id
                 , COALESCE(sm.up_menu_id, 'ROOT') AS UP_MENU_ID
                 , sm.page_id
                 , sml.mlang_txt AS MENU_NM
                 , sm.srt_sn
                 , 0 AS LEVEL
              FROM sys_menu sm
              JOIN sys_mlang sml
                ON sm.menu_id = sml.mlang_id
               AND sml.mlang_tp_cd = 'MN'
               AND sml.lang_cd = #{sess_lang_cd}
             WHERE sm.cmpy_cd = #{sess_cmpy_cd}
               AND sm.usg_yn = 'Y'
               AND sm.menu_id != 'Z01'
               AND EXISTS (SELECT 1
                           FROM sys_menu_role smr
                          WHERE smr.menu_id LIKE sm.menu_id || '%'
                            AND smr.usg_yn = 'Y'
                            AND smr.role_id IN (SELECT role_id
                                                  FROM sys_user_role
                                                 WHERE user_id = #{sess_user_id}
                                                   AND usg_yn = 'Y'
                                                   AND del_yn = 'N')
                        )
        ),
        menu_with_level AS (
            SELECT menu_id, up_menu_id, page_id, menu_nm, srt_sn, 0 as LEVEL
            FROM menu_hierarchy
            WHERE up_menu_id IS NULL
            UNION ALL
            SELECT mh.menu_id, mh.up_menu_id, mh.page_id, mh.menu_nm, mh.srt_sn, mwl.LEVEL + 1
            FROM menu_hierarchy mh
            JOIN menu_with_level mwl ON mh.up_menu_id = mwl.menu_id
        )
        SELECT mwl.menu_id AS MENU_ID
             , mwl.up_menu_id AS UP_MENU_ID
             , mwl.page_id AS PAGE_ID
             , mwl.menu_nm AS MENU_NM
             , b.page_nm AS PAGE_NM
             , b.page_url AS PAGE_URL
             , mwl.srt_sn AS SRT_SN
             , mwl.LEVEL - 2 AS "LEVEL"
          FROM menu_with_level mwl
          LEFT JOIN (SELECT ' ' AS PAGE_ID
                         , NULL AS PAGE_NM
                         , NULL AS PAGE_URL
                     UNION ALL
                    SELECT sp.page_id
                         , sml.mlang_txt AS PAGE_NM
                         , sp.page_url
                      FROM sys_page sp
                      JOIN sys_mlang sml
                        ON sp.page_id = sml.mlang_id
                       AND sml.mlang_tp_cd = 'PG'
                       AND sml.lang_cd = #{sess_lang_cd}
                   ) b
            ON mwl.page_id = b.page_id
         WHERE mwl.menu_id IS NOT NULL
         ORDER BY mwl.srt_sn
    </select>

    <select id="selectLoginAccessPageList" parameterType="sqlMap" resultType="sqlMap">
        /* selectLoginAccessPageList - 로그인 사용자 접근 화면 목록 */
        SELECT sm.menu_id AS MENU_ID
             , fn_get_mlang('MN', sm.menu_id, #{sess_lang_cd}) AS MENU_NM
             , sp.page_id AS PAGE_ID
             , fn_get_mlang('PG', sp.page_id, #{sess_lang_cd}) AS PAGE_NM
             , sp.page_url AS PAGE_URL
             , '/' || sm.menu_id AS PATH
          FROM sys_menu sm
          JOIN sys_page sp
            ON sm.page_id = sp.page_id
           AND sm.page_id IS NOT NULL
         WHERE EXISTS (SELECT 1
                        FROM sys_menu_role smr
                       WHERE sm.menu_id = smr.menu_id
                         AND smr.usg_yn = 'Y'
                         AND smr.role_id IN (SELECT role_id
                                              FROM sys_user_role
                                             WHERE user_id = #{sess_user_id}
                                               AND usg_yn = 'Y'
                                               AND del_yn = 'N')
                     )
           AND sm.usg_yn = 'Y'
           AND sp.usg_yn = 'Y'
         UNION ALL
        SELECT sms.scrn_id AS MENU_ID
             , fn_get_mlang('MN', sms.menu_id, #{sess_lang_cd}) AS MENU_NM
             , sp.page_id AS PAGE_ID
             , fn_get_mlang('PG', sp.page_id, #{sess_lang_cd}) AS PAGE_NM
             , sp.page_url AS PAGE_URL
             , '/' || sms.menu_id AS PATH
          FROM sys_menu_scrn sms
          JOIN sys_page sp
            ON sms.page_id = sp.page_id
           AND sms.page_id IS NOT NULL
         WHERE EXISTS (SELECT 1
                        FROM sys_menu_role smr
                       WHERE sms.menu_id = smr.menu_id
                         AND smr.usg_yn = 'Y'
                         AND smr.role_id IN (SELECT role_id
                                              FROM sys_user_role
                                             WHERE user_id = #{sess_user_id}
                                               AND usg_yn = 'Y'
                                               AND del_yn = 'N')
                     )
           AND sp.usg_yn = 'Y'
    </select>

    <select id="selectVersionCheck" parameterType="sqlMap" resultType="sqlMap">
        /* selectVersionCheck - 로그인 사용자 접근 화면 목록 */
	    SELECT *
		  FROM sys_cd sc
		 WHERE sc.cd_grp_no = 'CO00000026'
	</select>

	<insert id="insertErrorLogs" parameterType="sqlMap">
        /* insertErrorLogs */
		<selectKey keyProperty="err_sn" resultType="String" order="BEFORE">
        	SELECT nextval('err_sn_seq')
    	</selectKey>
        INSERT INTO tb_cf_web_err_hst (
               err_dtm
              ,err_sn
              ,err_occr_page
              ,err_txt
              ,crt_user_id
              ,upt_user_id
		) VALUES (
		       TO_CHAR(NOW(), 'YYYYMMDDHH24MISS')
		      ,#{err_sn}
		      ,#{err_occr_page}	
		      ,#{logs}
			  ,#{sess_user_id}
			  ,#{sess_user_id}
		)
    </insert>
    
</mapper>

