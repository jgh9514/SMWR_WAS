<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cf.community.mapper.InquiryMapper">

	<!-- 1대1문의 목록 조회 -->
	<select id="selectInquiryList" parameterType="sqlMap" resultType="sqlMap">
		/* selectInquiryList */
		select i.inquiry_id
			  ,i.user_id
			  ,i.title
			  ,i.content
			  ,i.answer
			  ,i.status
			  ,i.answer_user_id
			  ,i.crt_date
			  ,i.answer_date
			  ,i.upt_date
			  ,tu.user_nm as user_name
			  ,tu2.user_nm as answer_user_name
		  from INQUIRY i
		  left outer join SYS_USER tu on i.user_id = tu.user_id
		  left outer join SYS_USER tu2 on i.answer_user_id = tu2.user_id
		 where i.del_yn = 'N'
		<if test='user_id != null and user_id != "" and is_admin != "Y"'>
		   and i.user_id = #{user_id}
		</if>
		<if test='status != null and status != "" and status != "ALL"'>
		   and i.status = #{status}
		</if>
		<if test='search != null and search != ""'>
		   and (i.title like concat('%', trim(#{search}), '%')
		    or i.content like concat('%', trim(#{search}), '%'))
		</if>
		 order by i.crt_date desc
		 limit #{limit} offset #{offset}
	</select>
	
	<!-- 1대1문의 개수 조회 -->
	<select id="selectInquiryCount" parameterType="sqlMap" resultType="int">
		/* selectInquiryCount */
		select count(1)
		  from INQUIRY i
		 where i.del_yn = 'N'
		<if test='user_id != null and user_id != "" and is_admin != "Y"'>
		   and i.user_id = #{user_id}
		</if>
		<if test='status != null and status != "" and status != "ALL"'>
		   and i.status = #{status}
		</if>
		<if test='search != null and search != ""'>
		   and (i.title like concat('%', trim(#{search}), '%')
		    or i.content like concat('%', trim(#{search}), '%'))
		</if>
	</select>
	
	<!-- 1대1문의 상세 조회 -->
	<select id="selectInquiryDtl" parameterType="sqlMap" resultType="sqlMap">
		/* selectInquiryDtl */
		select i.inquiry_id
			  ,i.user_id
			  ,i.title
			  ,i.content
			  ,i.answer
			  ,i.status
			  ,i.answer_user_id
			  ,i.crt_date
			  ,i.answer_date
			  ,i.upt_date
			  ,tu.user_nm as user_name
			  ,tu2.user_nm as answer_user_name
		  from INQUIRY i
		  left outer join SYS_USER tu on i.user_id = tu.user_id
		  left outer join SYS_USER tu2 on i.answer_user_id = tu2.user_id
		 where i.inquiry_id = #{inquiry_id}
		   and i.del_yn = 'N'
	</select>
	
	<!-- 1대1문의 등록 -->
	<insert id="insertInquiry" parameterType="sqlMap">
		/* insertInquiry */
		<selectKey keyProperty="inquiry_id" resultType="long" order="AFTER">
			SELECT currval('inquiry_seq')
		</selectKey>
		insert into INQUIRY (
			user_id
			,title
			,content
			,status
			,del_yn
			,crt_date
			,upt_date
		) values(
			#{sess_user_id}
			,#{title}
			,#{content}
			,'PENDING'
			,'N'
			,CURRENT_TIMESTAMP
			,CURRENT_TIMESTAMP
		)
	</insert>
	
	<!-- 1대1문의 답변 수정 -->
	<update id="updateInquiryAnswer" parameterType="sqlMap">
		/* updateInquiryAnswer */
		update INQUIRY set
			answer = #{answer}
			,status = 'ANSWERED'
			,answer_user_id = #{sess_user_id}
			,answer_date = CURRENT_TIMESTAMP
			,upt_date = CURRENT_TIMESTAMP
		where inquiry_id = #{inquiry_id}
		  and del_yn = 'N'
	</update>
	
	<!-- 1대1문의 삭제 (soft delete) -->
	<update id="deleteInquiry" parameterType="sqlMap">
		/* deleteInquiry */
		update INQUIRY set
			del_yn = 'Y'
			,upt_date = CURRENT_TIMESTAMP
		where inquiry_id = #{inquiry_id}
		  and del_yn = 'N'
	</update>
	
</mapper>

