<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.admin.api.mapper.ApiMapper">

	<!-- API 목록 조회 -->
	<select id="selectApiList" parameterType="sqlMap" resultType="sqlMap">
		/* selectApiList */
		SELECT 
			api_id,
			bsns_cd,
			dtl_bsns_cd,
			api_txt,
			api_url,
			crt_user_id,
			crt_date,
			upt_user_id,
			upt_date
		FROM SYS_API
		WHERE 1=1
		<if test="bsns_cd != null and bsns_cd != ''">
			AND bsns_cd = #{bsns_cd}
		</if>
		<if test="dtl_bsns_cd != null and dtl_bsns_cd != ''">
			AND dtl_bsns_cd = #{dtl_bsns_cd}
		</if>
		ORDER BY api_id ASC
	</select>

	<!-- API 키 조회 -->
	<select id="selectApiKey" parameterType="sqlMap" resultType="string">
		/* selectApiKey */
		SELECT MAX(api_id) as api_id
		FROM SYS_API
	</select>

	<!-- API 등록 -->
	<insert id="insertApiList" parameterType="sqlMap">
		/* insertApiList */
		INSERT INTO SYS_API (
			api_id,
			bsns_cd,
			dtl_bsns_cd,
			api_url,
			api_txt,
			crt_user_id,
			crt_date,
			upt_user_id,
			upt_date
		) VALUES (
			#{api_id},
			#{bsns_cd},
			#{dtl_bsns_cd},
			#{api_url},
			#{api_txt},
			#{sess_user_id},
			CURRENT_TIMESTAMP,
			#{sess_user_id},
			CURRENT_TIMESTAMP
		)
	</insert>

	<!-- API 수정 -->
	<update id="updateApiList" parameterType="sqlMap">
		/* updateApiList */
		UPDATE SYS_API
		SET bsns_cd = #{bsns_cd}
		   ,dtl_bsns_cd = #{dtl_bsns_cd}
		   ,api_url = #{api_url}
		   ,api_txt = #{api_txt}
		   ,upt_user_id = #{sess_user_id}
		   ,upt_date = CURRENT_TIMESTAMP
		WHERE api_id = #{api_id}
	</update>

	<!-- API 삭제 -->
	<delete id="deleteApiList" parameterType="sqlMap">
		/* deleteApiList */
		DELETE FROM SYS_API
		WHERE api_id = #{api_id}
	</delete>

	<!-- API 역할 삭제 -->
	<delete id="deleteApiRole" parameterType="sqlMap">
		/* deleteApiRole */
		DELETE FROM SYS_API_ROLE
		WHERE api_id = #{api_id}
	</delete>

	<!-- API 역할 등록 -->
	<insert id="insertApiRole" parameterType="sqlMap">
		/* insertApiRole */
		INSERT INTO SYS_API_ROLE (
			api_id,
			role_id,
			usg_yn,
			crt_user_id,
			crt_date,
			upt_user_id,
			upt_date
		) VALUES (
			#{api_id},
			#{role_id},
			'Y',
			#{sess_user_id},
			CURRENT_TIMESTAMP,
			#{sess_user_id},
			CURRENT_TIMESTAMP
		)
		ON CONFLICT (api_id, role_id)
		DO UPDATE SET
			usg_yn = 'Y',
			upt_user_id = #{sess_user_id},
			upt_date = CURRENT_TIMESTAMP
	</insert>

	<!-- API 역할 수정 -->
	<update id="updateApiRole" parameterType="sqlMap">
		/* updateApiRole */
		UPDATE SYS_API_ROLE
		SET usg_yn = #{usg_yn}
		   ,upt_user_id = #{sess_user_id}
		   ,upt_date = CURRENT_TIMESTAMP
		WHERE api_id = #{api_id}
		  AND role_id = #{role_id}
	</update>

	<!-- API URL로 조회 -->
	<select id="selectApiByUrl" parameterType="sqlMap" resultType="sqlMap">
		/* selectApiByUrl */
		SELECT api_id
		FROM SYS_API
		WHERE api_url = #{url}
		LIMIT 1
	</select>

</mapper>

