<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.smw.monster.mapper.SwarfarmLevelMapper">

    <!-- 레벨 정보 저장 또는 업데이트 -->
    <insert id="upsertLevel" parameterType="sqlMap">
        INSERT INTO public.level_master (
            level_id,
            dungeon_id,
            floor,
            difficulty,
            energy_cost,
            xp,
            frontline_slots,
            backline_slots,
            total_slots,
            swarfarm_url,
            last_sync_date,
            crt_user_id,
            crt_date,
            upt_user_id,
            upt_date
        ) VALUES (
            #{level_id},
            #{dungeon_id},
            #{floor},
            #{difficulty},
            #{energy_cost},
            #{xp},
            #{frontline_slots},
            #{backline_slots},
            #{total_slots},
            #{swarfarm_url},
            CURRENT_TIMESTAMP,
            COALESCE(#{crt_user_id}, 'SYSTEM'),
            CURRENT_TIMESTAMP,
            COALESCE(#{upt_user_id}, 'SYSTEM'),
            CURRENT_TIMESTAMP
        )
        ON CONFLICT (level_id) 
        DO UPDATE SET
            dungeon_id = EXCLUDED.dungeon_id,
            floor = EXCLUDED.floor,
            difficulty = EXCLUDED.difficulty,
            energy_cost = EXCLUDED.energy_cost,
            xp = EXCLUDED.xp,
            frontline_slots = EXCLUDED.frontline_slots,
            backline_slots = EXCLUDED.backline_slots,
            total_slots = EXCLUDED.total_slots,
            swarfarm_url = EXCLUDED.swarfarm_url,
            last_sync_date = CURRENT_TIMESTAMP,
            upt_user_id = COALESCE(EXCLUDED.upt_user_id, 'SYSTEM'),
            upt_date = CURRENT_TIMESTAMP
    </insert>

    <!-- Level ID로 레벨 존재 여부 확인 -->
    <select id="countByLevelId" parameterType="Integer" resultType="Integer">
        SELECT COUNT(*)
        FROM public.level_master
        WHERE level_id = #{level_id}
    </select>

    <!-- 레벨 웨이브 삭제 (CASCADE로 적도 함께 삭제됨) -->
    <delete id="deleteLevelWaves" parameterType="Integer">
        DELETE FROM public.level_waves
        WHERE level_id = #{level_id}
    </delete>

    <!-- 레벨 웨이브 저장 -->
    <insert id="insertLevelWave" parameterType="sqlMap">
        INSERT INTO public.level_waves (
            level_id,
            wave_number,
            crt_date
        ) VALUES (
            #{level_id},
            #{wave_number},
            CURRENT_TIMESTAMP
        )
        ON CONFLICT (level_id, wave_number) DO NOTHING
    </insert>

    <!-- 레벨 웨이브 적 몬스터 저장 -->
    <insert id="insertLevelEnemy" parameterType="sqlMap">
        INSERT INTO public.level_enemies (
            enemy_id,
            level_id,
            wave_number,
            monster_swarfarm_id,
            stars,
            level,
            hp,
            attack,
            defense,
            speed,
            resist,
            crit_bonus,
            crit_damage_reduction,
            accuracy_bonus,
            crt_date
        ) VALUES (
            #{enemy_id},
            #{level_id},
            #{wave_number},
            #{monster_swarfarm_id},
            #{stars},
            #{level},
            #{hp},
            #{attack},
            #{defense},
            #{speed},
            #{resist},
            COALESCE(#{crit_bonus}, 0),
            COALESCE(#{crit_damage_reduction}, 0),
            COALESCE(#{accuracy_bonus}, 0),
            CURRENT_TIMESTAMP
        )
        ON CONFLICT (enemy_id) DO NOTHING
    </insert>

</mapper>

