<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cf.community.mapper.NoticeMapper">

	<!-- 공지사항 목록 조회 -->
	<select id="selectNoticeList" parameterType="sqlMap" resultType="sqlMap">
		/* selectNoticeList */
		select n.notice_id
			  ,n.title
			  ,n.content
			  ,n.is_important
			  ,n.is_popup
			  ,n.view_count
			  ,n.crt_user_id
			  ,n.crt_date
			  ,n.upt_user_id
			  ,n.upt_date
			  ,tu.user_nm as user_name
		  from NOTICE n
		  left outer join SYS_USER tu on n.crt_user_id = tu.user_id
		 where n.del_yn = 'N'
		<if test='search != null and search != ""'>
		   and (n.title like concat('%', trim(#{search}), '%')
		    or n.content like concat('%', trim(#{search}), '%'))
		</if>
		 order by n.is_important desc, n.crt_date desc
		 limit #{limit} offset #{offset}
	</select>
	
	<!-- 공지사항 개수 조회 -->
	<select id="selectNoticeCount" parameterType="sqlMap" resultType="int">
		/* selectNoticeCount */
		select count(1)
		  from NOTICE n
		 where n.del_yn = 'N'
		<if test='search != null and search != ""'>
		   and (n.title like concat('%', trim(#{search}), '%')
		    or n.content like concat('%', trim(#{search}), '%'))
		</if>
	</select>
	
	<!-- 공지사항 상세 조회 -->
	<select id="selectNoticeDtl" parameterType="sqlMap" resultType="sqlMap">
		/* selectNoticeDtl */
		select n.notice_id
			  ,n.title
			  ,n.content
			  ,n.is_important
			  ,n.view_count
			  ,n.crt_user_id
			  ,n.crt_date
			  ,n.upt_user_id
			  ,n.upt_date
			  ,tu.user_nm as user_name
		  from NOTICE n
		  left outer join SYS_USER tu on n.crt_user_id = tu.user_id
		 where n.notice_id = #{notice_id}
		   and n.del_yn = 'N'
	</select>
	
	<!-- 공지사항 등록 -->
	<insert id="insertNotice" parameterType="sqlMap">
		/* insertNotice */
		<selectKey keyProperty="notice_id" resultType="long" order="AFTER">
			SELECT currval('notice_seq')
		</selectKey>
		insert into NOTICE (
			title
			,content
			,is_important
			,is_popup
			,view_count
			,del_yn
			,crt_user_id
			,crt_date
			,upt_user_id
			,upt_date
		) values(
			#{title}
			,#{content}
			,COALESCE(#{is_important}, false)
			,COALESCE(#{is_popup}, false)
			,0
			,'N'
			,#{sess_user_id}
			,CURRENT_TIMESTAMP
			,#{sess_user_id}
			,CURRENT_TIMESTAMP
		)
	</insert>
	
	<!-- 공지사항 수정 -->
	<update id="updateNotice" parameterType="sqlMap">
		/* updateNotice */
		update NOTICE set
			title = #{title}
			,content = #{content}
			,is_important = COALESCE(#{is_important}, false)
			,is_popup = COALESCE(#{is_popup}, false)
			,upt_user_id = #{sess_user_id}
			,upt_date = CURRENT_TIMESTAMP
		where notice_id = #{notice_id}
		  and del_yn = 'N'
	</update>
	
	<!-- 공지사항 삭제 (soft delete) -->
	<update id="deleteNotice" parameterType="sqlMap">
		/* deleteNotice */
		update NOTICE set
			del_yn = 'Y'
			,upt_user_id = #{sess_user_id}
			,upt_date = CURRENT_TIMESTAMP
		where notice_id = #{notice_id}
		  and del_yn = 'N'
	</update>
	
	<!-- 공지사항 조회수 증가 -->
	<update id="increaseNoticeView" parameterType="sqlMap">
		/* increaseNoticeView */
		update NOTICE set
			view_count = view_count + 1
			,upt_date = CURRENT_TIMESTAMP
		where notice_id = #{notice_id}
		  and del_yn = 'N'
	</update>
	
	<!-- 팝업 공지사항 목록 조회 (모든 팝업 공지사항 - 하루동안 안보기는 프론트엔드에서 처리) -->
	<select id="selectPopupNoticeList" parameterType="sqlMap" resultType="sqlMap">
		/* selectPopupNoticeList */
		select n.notice_id
			  ,n.title
			  ,n.content
			  ,n.is_important
			  ,n.is_popup
			  ,n.view_count
			  ,n.crt_user_id
			  ,n.crt_date
			  ,n.upt_user_id
			  ,n.upt_date
			  ,tu.user_nm as user_name
		  from NOTICE n
		  left outer join SYS_USER tu on n.crt_user_id = tu.user_id
		 where n.del_yn = 'N'
		   and n.is_popup = true
		 order by n.is_important desc, n.crt_date desc
	</select>
	
	<!-- 팝업 공지사항 조회 기록 개수 조회 -->
	<select id="selectPopupNoticeViewCount" parameterType="sqlMap" resultType="int">
		/* selectPopupNoticeViewCount */
		select count(1)
		  from NOTICE_VIEW nv
		 where nv.notice_id = #{notice_id}
		   and nv.user_id = #{sess_user_id}
		   and nv.del_yn = 'N'
	</select>
	
	<!-- 팝업 공지사항 조회 기록 저장 -->
	<insert id="insertPopupNoticeView" parameterType="sqlMap">
		/* insertPopupNoticeView */
		insert into NOTICE_VIEW (
			notice_id
			,user_id
			,del_yn
			,crt_user_id
			,crt_date
			,upt_user_id
			,upt_date
		) values(
			#{notice_id}
			,#{sess_user_id}
			,'N'
			,#{sess_user_id}
			,CURRENT_TIMESTAMP
			,#{sess_user_id}
			,CURRENT_TIMESTAMP
		)
	</insert>
	
</mapper>

