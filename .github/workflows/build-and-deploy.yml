name: Build and Deploy

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:  # 수동 실행도 가능하도록

env:
  DOCKER_IMAGE: gilhwanjeon/smw-app
  DOCKER_TAG: ${{ github.sha }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up JDK 8
      uses: actions/setup-java@v3
      with:
        java-version: '8'
        distribution: 'temurin'

    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Build with Maven
      run: mvn clean package -DskipTests

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Extract metadata (tags, labels) for Docker
      id: meta
      uses: docker/metadata-action@v4
      with:
        images: ${{ env.DOCKER_IMAGE }}
        tags: |
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
          type=raw,value=${{ github.run_number }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        file: ./Dockerfile
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=registry,ref=${{ env.DOCKER_IMAGE }}:latest
        cache-to: type=inline

  deploy-to-k8s:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Configure SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/ec2_key
        chmod 600 ~/.ssh/ec2_key
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

    - name: Deploy to Kubernetes via SSH
      run: |
        ssh -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
          set -e
          cd ~/SMWR_WAS
          
          # Git 저장소 설정 (없는 경우)
          if [ ! -d .git ]; then
            git init
            git remote add origin https://github.com/jgh9514/SMWR_WAS.git || true
            git fetch origin
            git checkout -b main origin/main || git reset --hard origin/main
          fi
          
          # 최신 코드 가져오기
          git pull origin main || git fetch origin && git reset --hard origin/main
          
          # 최신 이미지로 업데이트
          sed -i 's|image: gilhwanjeon/smw-app:.*|image: gilhwanjeon/smw-app:latest|g' k8s/deployment.yaml
          
          # PostgreSQL 배포
          kubectl apply -f k8s/postgres.yaml
          
          # 백엔드 배포
          kubectl apply -f k8s/deployment.yaml
          
          # Pod 재시작
          kubectl rollout restart deployment/smw-app 2>/dev/null || kubectl delete pod -l app=smw-app
          
          # 배포 상태 확인
          echo "=== 배포 상태 ==="
          kubectl get pods
          kubectl get services
          
          # 배포 완료 대기
          sleep 10
          kubectl get pods
        EOF


