<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.smw.monster.mapper.SwarfarmSkillMapper">

    <!-- 스킬 정보 저장 또는 업데이트 -->
    <insert id="upsertSkill" parameterType="sqlMap">
        INSERT INTO public.skill (
            skill_id,
            swarfarm_id,
            com2us_id,
            name,
            description,
            slot,
            cooltime,
            hits,
            passive,
            aoe,
            random,
            max_level,
            multiplier_formula,
            multiplier_formula_raw,
            scales_with,
            icon_filename,
            icon_path,
            level_progress_description,
            other_skill_id,
            swarfarm_url,
            last_sync_date,
            crt_user_id,
            crt_date,
            upt_user_id,
            upt_date
        ) VALUES (
            #{skill_id},
            #{swarfarm_id},
            #{com2us_id},
            #{name},
            #{description},
            #{slot},
            #{cooltime},
            COALESCE(#{hits}, 1),
            COALESCE(#{passive}, false),
            COALESCE(#{aoe}, false),
            COALESCE(#{random}, false),
            #{max_level},
            #{multiplier_formula},
            #{multiplier_formula_raw},
            #{scales_with},
            #{icon_filename},
            #{icon_path},
            #{level_progress_description},
            #{other_skill_id},
            #{swarfarm_url},
            CURRENT_TIMESTAMP,
            COALESCE(#{crt_user_id}, 'SYSTEM'),
            CURRENT_TIMESTAMP,
            COALESCE(#{upt_user_id}, 'SYSTEM'),
            CURRENT_TIMESTAMP
        )
        ON CONFLICT (skill_id) 
        DO UPDATE SET
            swarfarm_id = EXCLUDED.swarfarm_id,
            com2us_id = EXCLUDED.com2us_id,
            name = EXCLUDED.name,
            description = EXCLUDED.description,
            slot = EXCLUDED.slot,
            cooltime = EXCLUDED.cooltime,
            hits = EXCLUDED.hits,
            passive = EXCLUDED.passive,
            aoe = EXCLUDED.aoe,
            random = EXCLUDED.random,
            max_level = EXCLUDED.max_level,
            multiplier_formula = EXCLUDED.multiplier_formula,
            multiplier_formula_raw = EXCLUDED.multiplier_formula_raw,
            scales_with = EXCLUDED.scales_with,
            icon_filename = EXCLUDED.icon_filename,
            icon_path = EXCLUDED.icon_path,
            level_progress_description = EXCLUDED.level_progress_description,
            other_skill_id = EXCLUDED.other_skill_id,
            swarfarm_url = EXCLUDED.swarfarm_url,
            last_sync_date = CURRENT_TIMESTAMP,
            upt_user_id = COALESCE(EXCLUDED.upt_user_id, 'SYSTEM'),
            upt_date = CURRENT_TIMESTAMP
    </insert>

    <!-- Swarfarm ID로 스킬 존재 여부 확인 -->
    <select id="countBySwarfarmId" parameterType="Integer" resultType="Integer">
        SELECT COUNT(*)
        FROM public.skill
        WHERE swarfarm_id = #{swarfarm_id}
    </select>
    
    <!-- Swarfarm ID로 skill_id 찾기 -->
    <select id="findSkillIdBySwarfarmId" parameterType="Integer" resultType="String">
        SELECT skill_id
        FROM public.skill
        WHERE swarfarm_id = #{swarfarm_id}
        LIMIT 1
    </select>

    <!-- 스킬 업그레이드 삭제 -->
    <delete id="deleteSkillUpgrades" parameterType="String">
        DELETE FROM public.skill_upgrades
        WHERE skill_id = #{skill_id}
    </delete>

    <!-- 스킬 업그레이드 저장 -->
    <insert id="insertSkillUpgrade" parameterType="sqlMap">
        INSERT INTO public.skill_upgrades (
            skill_id,
            upgrade_level,
            effect,
            amount,
            crt_date
        ) VALUES (
            #{skill_id},
            #{upgrade_level},
            #{effect},
            #{amount},
            CURRENT_TIMESTAMP
        )
        ON CONFLICT (skill_id, upgrade_level) DO NOTHING
    </insert>

    <!-- 스킬 효과 삭제 -->
    <delete id="deleteSkillEffects" parameterType="String">
        DELETE FROM public.skill_effects
        WHERE skill_id = #{skill_id}
    </delete>

    <!-- 스킬 효과 저장 -->
    <insert id="insertSkillEffect" parameterType="sqlMap">
        INSERT INTO public.skill_effects (
            skill_id,
            effect_id,
            effect_name,
            effect_type,
            effect_description,
            is_buff,
            aoe,
            single_target,
            self_effect,
            chance,
            on_crit,
            on_death,
            random,
            quantity,
            all,
            self_hp,
            target_hp,
            damage,
            note,
            effect_order,
            crt_date
        ) VALUES (
            #{skill_id},
            #{effect_id},
            #{effect_name},
            #{effect_type},
            #{effect_description},
            #{is_buff},
            COALESCE(#{aoe}, false),
            COALESCE(#{single_target}, false),
            COALESCE(#{self_effect}, false),
            COALESCE(#{chance}, 0),
            COALESCE(#{on_crit}, false),
            COALESCE(#{on_death}, false),
            COALESCE(#{random}, false),
            #{quantity},
            COALESCE(#{all}, false),
            COALESCE(#{self_hp}, false),
            COALESCE(#{target_hp}, false),
            COALESCE(#{damage}, false),
            #{note},
            #{effect_order},
            CURRENT_TIMESTAMP
        )
        ON CONFLICT (skill_id, effect_id, effect_order) DO NOTHING
    </insert>

    <!-- 스킬 사용 몬스터 매핑 삭제 -->
    <delete id="deleteSkillUsedOn" parameterType="String">
        DELETE FROM public.skill_used_on
        WHERE skill_id = #{skill_id}
    </delete>

    <!-- 스킬 사용 몬스터 매핑 저장 -->
    <insert id="insertSkillUsedOn" parameterType="sqlMap">
        INSERT INTO public.skill_used_on (
            skill_id,
            monster_swarfarm_id,
            crt_date
        ) VALUES (
            #{skill_id},
            #{monster_swarfarm_id},
            CURRENT_TIMESTAMP
        )
        ON CONFLICT (skill_id, monster_swarfarm_id) DO NOTHING
    </insert>

</mapper>

