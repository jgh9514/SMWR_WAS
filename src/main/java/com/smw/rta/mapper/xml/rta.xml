<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.smw.rta.mapper.RtaMapper">

    <!-- RTA 매치 목록 조회 -->
    <select id="getRtaMatches" resultType="map">
        WITH user_info AS (
            SELECT 
                u.rid,
                u.wizard_id,
                u.wizard_name,
                u.country,
                u.score,
                u.rating_id,
                u.win_lose,
                u.is_first_pick,
                u.alive_count
            FROM ranker_rtpvp_replay_user_list u
        ),
        pick_info AS (
            SELECT 
                p.rid,
                p.wizard_id,
                p.banned_slot_id,
                p.leader_slot_id
            FROM ranker_rtpvp_replay_pick_list p
        ),
        unit_info AS (
            SELECT 
                u.rid,
                u.wizard_id,
                array_agg(u.unit_master_id ORDER BY u.pick_slot_id) as picked_units,
                array_agg(COALESCE(m.image_url, '/images/' || m.monster_elemental || '/' || replace(m.un_name, ' ', '_') || '_' || m.monster_elemental || '_Icon.png') ORDER BY u.pick_slot_id) as unit_images,
                array_agg(m.kr_name ORDER BY u.pick_slot_id) as unit_names,
                string_agg(u.unit_master_id, ',' ORDER BY u.pick_slot_id) as picked_units_str
            FROM ranker_rtpvp_replay_unit_list u
            LEFT JOIN monster m ON u.unit_master_id = m.monster_id
            GROUP BY u.rid, u.wizard_id
        ),
        match_info AS (
            SELECT 
                r.rid,
                r.battle_type,
                r.date_add,
                r.win_lose as winner_position
            FROM ranker_rtpvp_replay_list r
        )
        SELECT 
            m.rid,
            m.battle_type,
            m.date_add,
            m.winner_position,
            u1.wizard_id as p1_wizard_id,
            u1.wizard_name as p1_name,
            u1.country as p1_country,
            u1.score as p1_score,
            u1.rating_id as p1_rating,
            u1.win_lose as p1_result,
            u1.is_first_pick as p1_first_pick,
            u1.alive_count as p1_alive_count,
            p1.banned_slot_id as p1_banned_unit,
            p1.leader_slot_id as p1_leader_unit,
            COALESCE(un1.picked_units, ARRAY[]::text[]) as p1_units,
            COALESCE(un1.unit_images, ARRAY[]::text[]) as p1_unit_images,
            COALESCE(un1.unit_names, ARRAY[]::text[]) as p1_unit_names,
            COALESCE(un1.picked_units_str, '') as p1_units_str,
            u2.wizard_id as p2_wizard_id,
            u2.wizard_name as p2_name,
            u2.country as p2_country,
            u2.score as p2_score,
            u2.rating_id as p2_rating,
            u2.win_lose as p2_result,
            u2.is_first_pick as p2_first_pick,
            u2.alive_count as p2_alive_count,
            p2.banned_slot_id as p2_banned_unit,
            p2.leader_slot_id as p2_leader_unit,
            COALESCE(un2.picked_units, ARRAY[]::text[]) as p2_units,
            COALESCE(un2.unit_images, ARRAY[]::text[]) as p2_unit_images,
            COALESCE(un2.unit_names, ARRAY[]::text[]) as p2_unit_names,
            COALESCE(un2.picked_units_str, '') as p2_units_str
        FROM match_info m
        JOIN user_info u1 ON m.rid = u1.rid
        JOIN user_info u2 ON m.rid = u2.rid AND u1.wizard_id != u2.wizard_id
        JOIN pick_info p1 ON m.rid = p1.rid AND u1.wizard_id = p1.wizard_id
        JOIN pick_info p2 ON m.rid = p2.rid AND u2.wizard_id = p2.wizard_id
        LEFT JOIN unit_info un1 ON m.rid = un1.rid AND u1.wizard_id = un1.wizard_id
        LEFT JOIN unit_info un2 ON m.rid = un2.rid AND u2.wizard_id = un2.wizard_id
        ORDER BY m.date_add DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 특정 플레이어의 RTA 매치 목록 조회 -->
    <select id="getPlayerRtaMatches" resultType="map">
        WITH user_info AS (
            SELECT 
                u.rid,
                u.wizard_id,
                u.wizard_name,
                u.country,
                u.score,
                u.rating_id,
                u.win_lose,
                u.is_first_pick,
                u.alive_count
            FROM ranker_rtpvp_replay_user_list u
        ),
        pick_info AS (
            SELECT 
                p.rid,
                p.wizard_id,
                p.banned_slot_id,
                p.leader_slot_id
            FROM ranker_rtpvp_replay_pick_list p
        ),
        unit_info AS (
            SELECT 
                u.rid,
                u.wizard_id,
                array_agg(u.unit_master_id ORDER BY u.pick_slot_id) as picked_units,
                array_agg(COALESCE(m.image_url, '/images/' || m.monster_elemental || '/' || replace(m.un_name, ' ', '_') || '_' || m.monster_elemental || '_Icon.png') ORDER BY u.pick_slot_id) as unit_images,
                array_agg(m.kr_name ORDER BY u.pick_slot_id) as unit_names,
                string_agg(u.unit_master_id, ',' ORDER BY u.pick_slot_id) as picked_units_str
            FROM ranker_rtpvp_replay_unit_list u
            LEFT JOIN monster m ON u.unit_master_id = m.monster_id
            GROUP BY u.rid, u.wizard_id
        ),
        match_info AS (
            SELECT 
                r.rid,
                r.battle_type,
                r.date_add,
                r.win_lose as winner_position
            FROM ranker_rtpvp_replay_list r
        )
        SELECT 
            m.rid,
            m.battle_type,
            m.date_add,
            m.winner_position,
            u1.wizard_id as p1_wizard_id,
            u1.wizard_name as p1_name,
            u1.country as p1_country,
            u1.score as p1_score,
            u1.rating_id as p1_rating,
            u1.win_lose as p1_result,
            u1.is_first_pick as p1_first_pick,
            u1.alive_count as p1_alive_count,
            p1.banned_slot_id as p1_banned_unit,
            p1.leader_slot_id as p1_leader_unit,
            COALESCE(un1.picked_units, ARRAY[]::text[]) as p1_units,
            COALESCE(un1.unit_images, ARRAY[]::text[]) as p1_unit_images,
            COALESCE(un1.unit_names, ARRAY[]::text[]) as p1_unit_names,
            COALESCE(un1.picked_units_str, '') as p1_units_str,
            u2.wizard_id as p2_wizard_id,
            u2.wizard_name as p2_name,
            u2.country as p2_country,
            u2.score as p2_score,
            u2.rating_id as p2_rating,
            u2.win_lose as p2_result,
            u2.is_first_pick as p2_first_pick,
            u2.alive_count as p2_alive_count,
            p2.banned_slot_id as p2_banned_unit,
            p2.leader_slot_id as p2_leader_unit,
            COALESCE(un2.picked_units, ARRAY[]::text[]) as p2_units,
            COALESCE(un2.unit_images, ARRAY[]::text[]) as p2_unit_images,
            COALESCE(un2.unit_names, ARRAY[]::text[]) as p2_unit_names,
            COALESCE(un2.picked_units_str, '') as p2_units_str
        FROM match_info m
        JOIN user_info u1 ON m.rid = u1.rid
        JOIN user_info u2 ON m.rid = u2.rid AND u1.wizard_id != u2.wizard_id
        JOIN pick_info p1 ON m.rid = p1.rid AND u1.wizard_id = p1.wizard_id
        JOIN pick_info p2 ON m.rid = p2.rid AND u2.wizard_id = p2.wizard_id
        LEFT JOIN unit_info un1 ON m.rid = un1.rid AND u1.wizard_id = un1.wizard_id
        LEFT JOIN unit_info un2 ON m.rid = un2.rid AND u2.wizard_id = un2.wizard_id
        WHERE u1.wizard_id = #{wizardId} OR u2.wizard_id = #{wizardId}
        ORDER BY m.date_add DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 전체 RTA 매치 수 조회 -->
    <select id="getTotalRtaMatches" resultType="int">
        SELECT COUNT(DISTINCT r.rid)
        FROM ranker_rtpvp_replay_list r
    </select>

    <!-- 오늘 RTA 매치 수 조회 -->
    <select id="getTodayRtaMatches" resultType="int">
        SELECT COUNT(DISTINCT r.rid)
        FROM ranker_rtpvp_replay_list r
        WHERE DATE(r.date_add) = CURRENT_DATE
    </select>

    <!-- 이번 주 RTA 매치 수 조회 -->
    <select id="getWeeklyRtaMatches" resultType="int">
        SELECT COUNT(DISTINCT r.rid)
        FROM ranker_rtpvp_replay_list r
        WHERE r.date_add >= DATE_TRUNC('week', CURRENT_DATE)
    </select>

    <!-- 데이터 확인용 테스트 쿼리 -->
    <select id="testRtaData" resultType="map">
        SELECT 
            COUNT(*) as total_matches,
            COUNT(DISTINCT r.rid) as unique_matches,
            COUNT(DISTINCT u.wizard_id) as unique_users,
            COUNT(DISTINCT unit.unit_master_id) as unique_units
        FROM ranker_rtpvp_replay_list r
        LEFT JOIN ranker_rtpvp_replay_user_list u ON r.rid = u.rid
        LEFT JOIN ranker_rtpvp_replay_unit_list unit ON r.rid = unit.rid
        LIMIT 1
    </select>

    <!-- RTA 데이터 상세 확인 쿼리 -->
    <select id="debugRtaData" resultType="map">
        SELECT 
            r.rid,
            r.battle_type,
            r.date_add,
            COUNT(DISTINCT u.wizard_id) as player_count,
            COUNT(DISTINCT unit.unit_master_id) as unit_count,
            COUNT(DISTINCT p.wizard_id) as pick_count
        FROM ranker_rtpvp_replay_list r
        LEFT JOIN ranker_rtpvp_replay_user_list u ON r.rid = u.rid
        LEFT JOIN ranker_rtpvp_replay_unit_list unit ON r.rid = unit.rid
        LEFT JOIN ranker_rtpvp_replay_pick_list p ON r.rid = p.rid
        GROUP BY r.rid, r.battle_type, r.date_add
        ORDER BY r.date_add DESC
        LIMIT 5
    </select>

    <!-- 특정 매치의 상세 정보 확인 -->
    <select id="debugMatchDetail" parameterType="string" resultType="map">
        SELECT 
            'user_list' as table_name,
            COUNT(*) as record_count
        FROM ranker_rtpvp_replay_user_list 
        WHERE rid = #{rid}
        UNION ALL
        SELECT 
            'unit_list' as table_name,
            COUNT(*) as record_count
        FROM ranker_rtpvp_replay_unit_list 
        WHERE rid = #{rid}
        UNION ALL
        SELECT 
            'pick_list' as table_name,
            COUNT(*) as record_count
        FROM ranker_rtpvp_replay_pick_list 
        WHERE rid = #{rid}
    </select>

    <!-- RTA 몬스터별 통계 조회 -->
    <select id="getRtaMonsterStats" resultType="map">
        WITH match_count AS (
            SELECT COUNT(DISTINCT r.rid) as total_matches
            FROM ranker_rtpvp_replay_list r
        ),
        pick_stats AS (
            SELECT 
                u.unit_master_id,
                m.monster_elemental,
                m.kr_name as monster_name,
                COALESCE(m.image_url, '/images/' || m.monster_elemental || '/' || replace(m.un_name, ' ', '_') || '_' || m.monster_elemental || '_Icon.png') as monster_image,
                COUNT(*) as pick_count,
                COUNT(CASE WHEN u.pick_slot_id = 1 THEN 1 END) as first_pick_count
            FROM ranker_rtpvp_replay_unit_list u
            LEFT JOIN monster m ON u.unit_master_id = m.monster_id
            WHERE m.kr_name IS NOT NULL
            GROUP BY u.unit_master_id, m.monster_elemental, m.kr_name, m.un_name, m.image_url
        ),
        ban_stats AS (
            SELECT 
                u.unit_master_id,
                COUNT(*) as ban_count
            FROM ranker_rtpvp_replay_pick_list p
            JOIN ranker_rtpvp_replay_unit_list u ON p.rid = u.rid 
                AND p.wizard_id = u.wizard_id 
                AND p.banned_slot_id = u.pick_slot_id
            WHERE p.banned_slot_id IS NOT NULL
            GROUP BY u.unit_master_id
        ),
        win_stats AS (
            SELECT 
                u.unit_master_id,
                COUNT(*) as win_count
            FROM ranker_rtpvp_replay_unit_list u
            JOIN ranker_rtpvp_replay_user_list ul ON u.rid = ul.rid AND u.wizard_id = ul.wizard_id
            JOIN ranker_rtpvp_replay_list r ON u.rid = r.rid
            WHERE ul.win_lose = r.win_lose
            GROUP BY u.unit_master_id
        )
        SELECT 
            ps.unit_master_id as monster_id,
            ps.monster_elemental,
            ps.monster_name,
            ps.monster_image,
            ps.pick_count,
            ROUND((ps.pick_count::numeric / mc.total_matches * 100)::numeric, 2) as pick_rate,
            CASE 
                WHEN ps.pick_count > 0 THEN ROUND((COALESCE(ws.win_count, 0)::numeric / ps.pick_count * 100)::numeric, 2)
                ELSE 0
            END as win_rate,
            CASE 
                WHEN ps.pick_count > 0 THEN ROUND((ps.first_pick_count::numeric / ps.pick_count * 100)::numeric, 2)
                ELSE 0
            END as first_pick_rate,
            ROUND((COALESCE(bs.ban_count, 0)::numeric / mc.total_matches * 100)::numeric, 2) as ban_rate
        FROM pick_stats ps
        CROSS JOIN match_count mc
        LEFT JOIN ban_stats bs ON ps.unit_master_id = bs.unit_master_id
        LEFT JOIN win_stats ws ON ps.unit_master_id = ws.unit_master_id
        WHERE ps.pick_count > 0
        ORDER BY ps.pick_count DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- RTA 몬스터 기본 정보 조회 -->
    <select id="getRtaMonsterBasicInfo" resultType="map">
        WITH match_count AS (
            SELECT COUNT(DISTINCT r.rid) as total_matches
            FROM ranker_rtpvp_replay_list r
        ),
        pick_stats AS (
            SELECT 
                u.unit_master_id,
                m.monster_elemental,
                m.kr_name as monster_name,
                COALESCE(m.image_url, '/images/' || m.monster_elemental || '/' || replace(m.un_name, ' ', '_') || '_' || m.monster_elemental || '_Icon.png') as monster_image,
                COUNT(*) as pick_count,
                COUNT(CASE WHEN u.pick_slot_id = 1 THEN 1 END) as first_pick_count
            FROM ranker_rtpvp_replay_unit_list u
            LEFT JOIN monster m ON u.unit_master_id = m.monster_id
            WHERE m.kr_name IS NOT NULL
                AND u.unit_master_id = #{monsterId}
            GROUP BY u.unit_master_id, m.monster_elemental, m.kr_name, m.un_name, m.image_url
        ),
        ban_stats AS (
            SELECT 
                u.unit_master_id,
                COUNT(*) as ban_count
            FROM ranker_rtpvp_replay_pick_list p
            JOIN ranker_rtpvp_replay_unit_list u ON p.rid = u.rid 
                AND p.wizard_id = u.wizard_id 
                AND p.banned_slot_id = u.pick_slot_id
            WHERE p.banned_slot_id IS NOT NULL
                AND u.unit_master_id = #{monsterId}
            GROUP BY u.unit_master_id
        ),
        win_stats AS (
            SELECT 
                u.unit_master_id,
                COUNT(*) as win_count
            FROM ranker_rtpvp_replay_unit_list u
            JOIN ranker_rtpvp_replay_user_list ul ON u.rid = ul.rid AND u.wizard_id = ul.wizard_id
            JOIN ranker_rtpvp_replay_list r ON u.rid = r.rid
            WHERE ul.win_lose = r.win_lose
                AND u.unit_master_id = #{monsterId}
            GROUP BY u.unit_master_id
        )
        SELECT 
            ps.unit_master_id as monster_id,
            ps.monster_elemental,
            ps.monster_name,
            ps.monster_image,
            ps.pick_count,
            ROUND((ps.pick_count::numeric / mc.total_matches * 100)::numeric, 2) as pick_rate,
            CASE 
                WHEN ps.pick_count > 0 THEN ROUND((COALESCE(ws.win_count, 0)::numeric / ps.pick_count * 100)::numeric, 2)
                ELSE 0
            END as win_rate,
            CASE 
                WHEN ps.pick_count > 0 THEN ROUND((ps.first_pick_count::numeric / ps.pick_count * 100)::numeric, 2)
                ELSE 0
            END as first_pick_rate,
            ROUND((COALESCE(bs.ban_count, 0)::numeric / mc.total_matches * 100)::numeric, 2) as ban_rate
        FROM pick_stats ps
        CROSS JOIN match_count mc
        LEFT JOIN ban_stats bs ON ps.unit_master_id = bs.unit_master_id
        LEFT JOIN win_stats ws ON ps.unit_master_id = ws.unit_master_id
        LIMIT 1
    </select>

    <!-- RTA 몬스터 강한 상대 조회 (이 몬스터가 상대했을 때 승률이 높은 몬스터) -->
    <select id="getRtaMonsterStrongAgainst" resultType="map">
        WITH my_matches AS (
            SELECT DISTINCT u1.rid, u1.wizard_id
            FROM ranker_rtpvp_replay_unit_list u1
            WHERE u1.unit_master_id = #{monsterId}
        ),
        opponent_stats AS (
            SELECT 
                u2.unit_master_id as opponent_monster_id,
                m.monster_elemental as opponent_monster_elemental,
                m.kr_name as opponent_monster_name,
                COALESCE(m.image_url, '/images/' || m.monster_elemental || '/' || replace(m.un_name, ' ', '_') || '_' || m.monster_elemental || '_Icon.png') as opponent_monster_image,
                COUNT(*) as match_count,
                SUM(CASE WHEN ul1.win_lose = r.win_lose THEN 1 ELSE 0 END) as win_count
            FROM my_matches mm
            JOIN ranker_rtpvp_replay_unit_list u2 ON mm.rid = u2.rid
            JOIN ranker_rtpvp_replay_user_list ul1 ON mm.rid = ul1.rid AND mm.wizard_id = ul1.wizard_id
            JOIN ranker_rtpvp_replay_user_list ul2 ON mm.rid = ul2.rid AND u2.wizard_id = ul2.wizard_id AND ul1.wizard_id != ul2.wizard_id
            JOIN ranker_rtpvp_replay_list r ON mm.rid = r.rid
            LEFT JOIN monster m ON u2.unit_master_id = m.monster_id
            WHERE u2.unit_master_id != #{monsterId}
                AND m.kr_name IS NOT NULL
            GROUP BY u2.unit_master_id, m.monster_elemental, m.kr_name, m.un_name, m.image_url
            HAVING COUNT(*) >= 10
        )
        SELECT 
            opponent_monster_id as monster_id,
            opponent_monster_elemental as monster_elemental,
            opponent_monster_name as monster_name,
            opponent_monster_image as monster_image,
            CASE 
                WHEN match_count > 0 THEN ROUND((win_count::numeric / match_count * 100)::numeric, 2)
                ELSE 0
            END as win_rate,
            match_count
        FROM opponent_stats
        ORDER BY win_rate DESC, match_count DESC
        LIMIT 20
    </select>

    <!-- RTA 몬스터 좋은 콤비 조회 (함께 사용했을 때 승률이 높은 몬스터) -->
    <select id="getRtaMonsterGoodCombos" resultType="map">
        WITH my_matches AS (
            SELECT DISTINCT u1.rid, u1.wizard_id
            FROM ranker_rtpvp_replay_unit_list u1
            WHERE u1.unit_master_id = #{monsterId}
        ),
        combo_stats AS (
            SELECT 
                u2.unit_master_id as combo_monster_id,
                m.monster_elemental as combo_monster_elemental,
                m.kr_name as combo_monster_name,
                COALESCE(m.image_url, '/images/' || m.monster_elemental || '/' || replace(m.un_name, ' ', '_') || '_' || m.monster_elemental || '_Icon.png') as combo_monster_image,
                COUNT(*) as match_count,
                SUM(CASE WHEN ul.win_lose = r.win_lose THEN 1 ELSE 0 END) as win_count
            FROM my_matches mm
            JOIN ranker_rtpvp_replay_unit_list u2 ON mm.rid = u2.rid AND mm.wizard_id = u2.wizard_id
            JOIN ranker_rtpvp_replay_user_list ul ON mm.rid = ul.rid AND mm.wizard_id = ul.wizard_id
            JOIN ranker_rtpvp_replay_list r ON mm.rid = r.rid
            LEFT JOIN monster m ON u2.unit_master_id = m.monster_id
            WHERE u2.unit_master_id != #{monsterId}
                AND m.kr_name IS NOT NULL
            GROUP BY u2.unit_master_id, m.monster_elemental, m.kr_name, m.un_name, m.image_url
            HAVING COUNT(*) >= 10
        )
        SELECT 
            combo_monster_id as monster_id,
            combo_monster_elemental as monster_elemental,
            combo_monster_name as monster_name,
            combo_monster_image as monster_image,
            CASE 
                WHEN match_count > 0 THEN ROUND((win_count::numeric / match_count * 100)::numeric, 2)
                ELSE 0
            END as win_rate,
            match_count
        FROM combo_stats
        ORDER BY win_rate DESC, match_count DESC
        LIMIT 20
    </select>

    <!-- RTA 몬스터 좋은 3체인 콤비 조회 (2개 몬스터와 함께 사용했을 때 승률이 높은 조합) -->
    <select id="getRtaMonsterGoodTripleCombos" resultType="map">
        WITH my_matches AS (
            -- 내가 사용한 매치들
            SELECT DISTINCT u1.rid, u1.wizard_id
            FROM ranker_rtpvp_replay_unit_list u1
            WHERE u1.unit_master_id = #{monsterId}
        ),
        triple_combo_stats AS (
            SELECT 
                u2.unit_master_id as monster1_id,
                m1.monster_elemental as monster1_elemental,
                m1.kr_name as monster1_name,
                '/images/' || m1.monster_elemental || '/' || replace(m1.un_name, ' ', '_') || '_' || m1.monster_elemental || '_Icon.png' as monster1_image,
                u3.unit_master_id as monster2_id,
                m2.monster_elemental as monster2_elemental,
                m2.kr_name as monster2_name,
                '/images/' || m2.monster_elemental || '/' || replace(m2.un_name, ' ', '_') || '_' || m2.monster_elemental || '_Icon.png' as monster2_image,
                COUNT(*) as match_count,
                SUM(CASE WHEN ul.win_lose = r.win_lose THEN 1 ELSE 0 END) as win_count
            FROM my_matches mm
            JOIN ranker_rtpvp_replay_unit_list u2 ON mm.rid = u2.rid AND mm.wizard_id = u2.wizard_id
            JOIN ranker_rtpvp_replay_unit_list u3 ON mm.rid = u3.rid AND mm.wizard_id = u3.wizard_id
            JOIN ranker_rtpvp_replay_user_list ul ON mm.rid = ul.rid AND mm.wizard_id = ul.wizard_id
            JOIN ranker_rtpvp_replay_list r ON mm.rid = r.rid
            LEFT JOIN monster m1 ON u2.unit_master_id = m1.monster_id
            LEFT JOIN monster m2 ON u3.unit_master_id = m2.monster_id
            WHERE u2.unit_master_id != #{monsterId}
                AND u3.unit_master_id != #{monsterId}
                AND u2.unit_master_id &lt; u3.unit_master_id
                AND m1.kr_name IS NOT NULL
                AND m2.kr_name IS NOT NULL
            GROUP BY u2.unit_master_id, m1.monster_elemental, m1.kr_name, m1.un_name,
                     u3.unit_master_id, m2.monster_elemental, m2.kr_name, m2.un_name
            HAVING COUNT(*) >= 5
        )
        SELECT 
            monster1_id,
            monster1_elemental,
            monster1_name,
            monster1_image,
            monster2_id,
            monster2_elemental,
            monster2_name,
            monster2_image,
            CASE 
                WHEN match_count > 0 THEN ROUND((win_count::numeric / match_count * 100)::numeric, 2)
                ELSE 0
            END as win_rate,
            match_count
        FROM triple_combo_stats
        ORDER BY win_rate DESC, match_count DESC
        LIMIT 20
    </select>

    <!-- RTA 몬스터 최근 경기 조회 -->
    <select id="getRtaMonsterRecentMatches" resultType="map">
        WITH my_matches AS (
            SELECT DISTINCT u1.rid, u1.wizard_id, r.date_add
            FROM ranker_rtpvp_replay_unit_list u1
            JOIN ranker_rtpvp_replay_list r ON u1.rid = r.rid
            WHERE u1.unit_master_id = #{monsterId}
            ORDER BY r.date_add DESC
            LIMIT 20
        ),
        my_team_json AS (
            SELECT 
                mm.rid,
                mm.wizard_id,
                json_agg(
                    json_build_object(
                        'monster_id', u1.unit_master_id,
                        'monster_name', COALESCE(m1.kr_name, ''),
                        'monster_image', CASE 
                            WHEN m1.kr_name IS NOT NULL THEN '/images/' || m1.monster_elemental || '/' || replace(m1.un_name, ' ', '_') || '_' || m1.monster_elemental || '_Icon.png'
                            ELSE ''
                        END
                    ) ORDER BY u1.pick_slot_id
                ) as my_team
            FROM my_matches mm
            JOIN ranker_rtpvp_replay_unit_list u1 ON mm.rid = u1.rid AND mm.wizard_id = u1.wizard_id
            LEFT JOIN monster m1 ON u1.unit_master_id = m1.monster_id
            GROUP BY mm.rid, mm.wizard_id
        ),
        opponent_team_json AS (
            SELECT 
                mm.rid,
                json_agg(
                    json_build_object(
                        'monster_id', u2.unit_master_id,
                        'monster_name', COALESCE(m2.kr_name, ''),
                        'monster_image', CASE 
                            WHEN m2.kr_name IS NOT NULL THEN '/images/' || m2.monster_elemental || '/' || replace(m2.un_name, ' ', '_') || '_' || m2.monster_elemental || '_Icon.png'
                            ELSE ''
                        END
                    ) ORDER BY u2.pick_slot_id
                ) as opponent_team
            FROM my_matches mm
            JOIN ranker_rtpvp_replay_unit_list u2 ON mm.rid = u2.rid AND mm.wizard_id != u2.wizard_id
            LEFT JOIN monster m2 ON u2.unit_master_id = m2.monster_id
            GROUP BY mm.rid
        )
        SELECT 
            mm.rid as match_id,
            mm.date_add as match_date,
            CASE WHEN ul.win_lose = r.win_lose THEN 'WIN' ELSE 'LOSE' END as win_lose,
            COALESCE(mt.my_team::text, '[]') as my_team,
            COALESCE(ot.opponent_team::text, '[]') as opponent_team
        FROM my_matches mm
        JOIN ranker_rtpvp_replay_user_list ul ON mm.rid = ul.rid AND mm.wizard_id = ul.wizard_id
        JOIN ranker_rtpvp_replay_list r ON mm.rid = r.rid
        LEFT JOIN my_team_json mt ON mm.rid = mt.rid AND mm.wizard_id = mt.wizard_id
        LEFT JOIN opponent_team_json ot ON mm.rid = ot.rid
        ORDER BY mm.date_add DESC
    </select>
</mapper>