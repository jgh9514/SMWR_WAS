<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.cf.community.mapper.CommentMapper">

	<!-- 댓글 목록 조회 -->
	<select id="selectCommentList" resultType="map">
		SELECT 
			c.comment_id,
			c.board_type,
			c.board_id,
			c.parent_comment_id,
			c.user_id,
			c.user_name,
			c.content,
			c.del_yn,
			c.crt_date,
			c.mdf_date,
			c.crt_user_id,
			c.mdf_user_id
		FROM COMMENT c
		WHERE c.board_type = #{board_type}
		  AND c.board_id = #{board_id}
		  AND c.del_yn = 'N'
		ORDER BY 
			CASE WHEN c.parent_comment_id IS NULL THEN c.crt_date END ASC,
			c.parent_comment_id ASC,
			c.crt_date ASC
	</select>

	<!-- 댓글 상세 조회 -->
	<select id="selectCommentDetail" resultType="map">
		SELECT 
			c.comment_id,
			c.board_type,
			c.board_id,
			c.parent_comment_id,
			c.user_id,
			c.user_name,
			c.content,
			c.del_yn,
			c.crt_date,
			c.mdf_date,
			c.crt_user_id,
			c.mdf_user_id
		FROM COMMENT c
		WHERE c.comment_id = #{comment_id}
		  AND c.del_yn = 'N'
	</select>

	<!-- 댓글 등록 -->
	<insert id="insertComment">
		INSERT INTO COMMENT (
			comment_id,
			board_type,
			board_id,
			parent_comment_id,
			user_id,
			user_name,
			content,
			del_yn,
			crt_date,
			mdf_date,
			crt_user_id,
			mdf_user_id
		) VALUES (
			#{comment_id},
			#{board_type},
			#{board_id},
			#{parent_comment_id},
			#{sess_user_id},
			(SELECT user_nm FROM SYS_USER WHERE user_id = #{sess_user_id}),
			#{content},
			COALESCE(#{del_yn}, 'N'),
			CURRENT_TIMESTAMP,
			CURRENT_TIMESTAMP,
			#{sess_user_id},
			#{sess_user_id}
		)
	</insert>

	<!-- 댓글 수정 -->
	<update id="updateComment">
		UPDATE COMMENT
		SET 
			content = #{content},
			mdf_date = CURRENT_TIMESTAMP,
			mdf_user_id = #{sess_user_id}
		WHERE comment_id = #{comment_id}
		  AND user_id = #{sess_user_id}
		  AND del_yn = 'N'
	</update>

	<!-- 댓글 삭제 -->
	<update id="deleteComment">
		UPDATE COMMENT
		SET 
			del_yn = #{del_yn},
			mdf_date = CURRENT_TIMESTAMP,
			mdf_user_id = #{sess_user_id}
		WHERE comment_id = #{comment_id}
		  AND (
		  	user_id = #{sess_user_id}
		  	OR EXISTS (
		  		SELECT 1 FROM SYS_USER_ROLE sur
		  		JOIN SYS_ROLE sr ON sur.role_id = sr.role_id
		  		WHERE sur.user_id = #{sess_user_id}
		  		  AND sr.role_id = 'RL0001'
		  		  AND sur.usg_yn = 'Y'
		  		  AND sur.del_yn = 'N'
		  	)
		  )
	</update>

</mapper>

