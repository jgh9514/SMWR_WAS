<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.admin.batch.mapper.BatchMapper">

	<!-- 배치 등록 -->
	<insert id="insertBatch" parameterType="sqlMap" useGeneratedKeys="true" keyProperty="bat_id" keyColumn="bat_id">
		/* insertBatch */
		INSERT INTO sys_batch_config (
			bat_nm,
			job_class,
			cron_expr,
			use_yn,
			sort_sn,
			desc_txt,
			crt_user_id,
			crt_date,
			upt_user_id,
			upt_date
		) VALUES (
			#{bat_nm},
			#{bat_cls_nm},
			COALESCE(#{cron_expr}, '0 0 0 * * ?'),
			COALESCE(#{use_yn}, 'Y'),
			COALESCE(#{sort_sn}, 0),
			#{desc_txt},
			#{sess_user_id},
			CURRENT_TIMESTAMP,
			#{sess_user_id},
			CURRENT_TIMESTAMP
		)
	</insert>

	<!-- 배치 설정 조회 -->
	<select id="selectBatchConfig" parameterType="sqlMap" resultType="sqlMap">
		/* selectBatchConfig */
		SELECT 
			bat_id,
			bat_nm,
			job_class,
			job_class as bat_cls_nm,
			use_yn,
			use_yn as usg_yn,
			cron_expr,
			sort_sn,
			desc_txt
		FROM sys_batch_config
		WHERE 1=1
		<if test="bat_id != null and bat_id != ''">
			AND bat_id = #{bat_id}
		</if>
		ORDER BY sort_sn ASC, bat_id ASC
	</select>

	<!-- 배치 수정 -->
	<update id="updateBatch" parameterType="sqlMap">
		/* updateBatch */
		UPDATE sys_batch_config
		SET bat_nm = #{bat_nm}
		   ,job_class = #{bat_cls_nm}
		   ,cron_expr = COALESCE(#{cron_expr}, cron_expr)
		   ,use_yn = #{use_yn}
		   ,sort_sn = COALESCE(#{sort_sn}, sort_sn)
		   ,desc_txt = #{desc_txt}
		   ,upt_user_id = #{sess_user_id}
		   ,upt_date = CURRENT_TIMESTAMP
		WHERE bat_id = #{bat_id}
	</update>

	<!-- 클래스명 조회 -->
	<select id="getClassName" parameterType="string" resultType="string">
		/* getClassName */
		SELECT job_class
		FROM sys_batch_config
		WHERE bat_id = #{param}
	</select>

	<!-- 배치 실행 이력 등록 -->
	<insert id="insertBatchRunHis" parameterType="sqlMap" useGeneratedKeys="true" keyProperty="run_sn" keyColumn="run_sn">
		/* insertBatchRunHis */
		INSERT INTO sys_batch_run_his (
			bat_id,
			start_dtm,
			rslt_cd,
			rslt_txt,
			crt_user_id,
			crt_date
		) VALUES (
			#{bat_id},
			CURRENT_TIMESTAMP,
			#{rslt_cd},
			#{rslt_txt},
			#{sess_user_id},
			CURRENT_TIMESTAMP
		)
	</insert>

	<!-- 배치 실행 이력 수정 -->
	<update id="updateBatchRunHis" parameterType="sqlMap">
		/* updateBatchRunHis */
		UPDATE sys_batch_run_his
		SET end_dtm = CURRENT_TIMESTAMP
		   ,rslt_cd = #{rslt_cd}
		   ,rslt_txt = #{rslt_txt}
		WHERE run_sn = #{run_sn}
	</update>

	<!-- 배치 실행 이력 목록 조회 -->
	<select id="selectBatchRunHisList" parameterType="sqlMap" resultType="sqlMap">
		/* selectBatchRunHisList */
		SELECT 
			run_sn as bat_exe_log_sn,
			bat_id,
			start_dtm as exe_dtm,
			end_dtm,
			rslt_cd,
			rslt_txt,
			crt_user_id,
			crt_date
		FROM sys_batch_run_his
		WHERE 1=1
		<if test="bat_id != null and bat_id != ''">
			AND bat_id = #{bat_id}
		</if>
		ORDER BY run_sn DESC
		LIMIT 1000
	</select>

	<!-- 배치 실행 이력 상세 조회 -->
	<select id="selectBatchRunHisDetail" parameterType="long" resultType="sqlMap">
		/* selectBatchRunHisDetail */
		SELECT 
			run_sn as bat_exe_log_sn,
			bat_id,
			start_dtm as exe_dtm,
			end_dtm,
			rslt_cd,
			rslt_txt,
			crt_user_id,
			crt_date
		FROM sys_batch_run_his
		WHERE run_sn = #{runSn}
	</select>

	<!-- 배치 이력 목록 조회 -->
	<select id="selectBatHisList" parameterType="sqlMap" resultType="sqlMap">
		/* selectBatHisList */
		SELECT 
			run_sn as bat_exe_log_sn,
			bat_id,
			start_dtm as exe_dtm,
			end_dtm,
			rslt_cd,
			rslt_txt
		FROM sys_batch_run_his
		WHERE 1=1
		ORDER BY run_sn DESC
		LIMIT 1000
	</select>

	<!-- 배치 목록 조회 -->
	<select id="selectBatchList" parameterType="sqlMap" resultType="sqlMap">
		/* selectBatchList */
		SELECT 
			run_sn as bat_exe_log_sn,
			bat_id,
			start_dtm as exe_dtm,
			end_dtm,
			rslt_cd,
			rslt_txt
		FROM sys_batch_run_his
		WHERE 1=1
		ORDER BY run_sn DESC
		LIMIT 1000
	</select>

</mapper>

